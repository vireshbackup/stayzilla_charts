<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Plain Leaflet API</title>

		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
		<script src='lib/mapbox.js'></script>
		<link href='css/mapbox.css' rel='stylesheet' />

		<link href="css/dc.css" rel='stylesheet' />
		<link href="css/custom.css" rel='stylesheet' />
		<link rel="stylesheet" href="css/leaflet.css" />
		<script type="text/javascript"  src="lib/d3.js"></script>
		<script type="text/javascript" src="lib/crossfilter.js"></script>
		<script type="text/javascript" src="lib/d3.tip.v0.6.3.js"></script>
		<script type="text/javascript" src="lib/dc.js"></script>

	</head>
	<body>

		<div id='map'></div>

		<div id="tierTypeRowChart"></div>
		<div id="amenityTypeChart"></div>

		<script>


		L.mapbox.accessToken = 'pk.eyJ1IjoidGVqZXNoOTUiLCJhIjoiNTdlZWI0NGEwMzU1NmRmNzYzNzZmY2ZhMmY0YTFhMDAifQ.KTwxWh-vcPO6tv3IKHJvBQ';
		// Replace 'mapbox.streets' with your map id.
		var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=' + L.mapbox.accessToken, {
		    attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
		});




		var map = L.map('map')
		    .addLayer(mapboxTiles)
		    .setView([21.0000 , 78.0000], 5);


		var tip = d3.tip()
          .attr("class", "d3-tip")
          .html(function(d){ 
          		// console.log(d);
          		return "<br> hotel Id :"+ d.hid
          				+"<br>ATM : "+parseInt(d.atm*1000)+"m"
          				+"<br>Bar : "+ parseInt(d.bar*1000)+"m"
          				+"<br>Bus Station : "+ parseInt(d.bus_station*1000)+"m"
          				+"<br>Restaurents : "+ parseInt(d.food*1000)+"m"
          				+"<br>hospital : "+ parseInt(d.hospital*1000)+"m"
          				+"<br>Landmarks : "+ parseInt(d.landmarks*1000)+"m"
          				+"<br>Movie Theatres : "+ parseInt(d.movie_theatre*1000)+"m"
          				+"<br>offices : "+ parseInt(d.offices*1000)+"m"
          				+"<br>spa/gyms : "+ parseInt(d.spa_gym*1000)+"m </br>"})

		//Initialize svg layer 
    	map._initPathRoot()

		var svg = d3.select("#map").select("svg"),
    	g = svg.append("g")

    	// Pick up SVG from map object
    	d3.csv("data/csv_sample.csv", function(csv){

    		csv.forEach(function(d){
    			d.tier = +d.tier;

    		})

    		csv.forEach(function(d){
    			d.LatLng = new L.LatLng(d.lat, d.lng);
    		})

    		total_hotels = csv.length;

    		var ndx = crossfilter(csv);
    		console.log(ndx);
     		var tierTypeDimension = ndx.dimension(function(d){ return d.tier;});
     		// var amenityTypeChart = ndx.dimension( function(d){ return d.bar;});
    		var tierTypeGroup = tierTypeDimension.group();

    		//For filtering based on tier
    		tierTypeFilterDimension = ndx.dimension(function(d){ return d.tier;})

    		var barDistance = ndx.dimension(function(d){ 
    				if(d.bar*1000 > 500)
    					return "near(<500m)";
    				else
    					return "far(>500m)";
    		})

    		var barGroup = barDistance.group();

    	var amenityPieChart = dc.pieChart("#amenityTypeChart");
    	amenityPieChart
    		.width(200)
    		.height(200)
    		.radius(90)
    		.dimension(barDistance)
    		.group(barGroup)
    		.innerRadius(30)
    		.colors(d3.scale.ordinal().domain(["near(<500m)","far(>500m)"])
                                        .range(["green", "orange"]))
    		.renderTitle(true)
    		.title(function(d,i){ return "x % of hotels have bar nearby";})
		function hotelPoints(){

		    	var feature = g.selectAll("circle")
								.data(tierTypeFilterDimension.top(Infinity))

						feature.enter()
								.append("circle")
								.style("fill", function(d,i){
										switch(d.tier){
											case 1:
												return "#7323DC";
												break;
											case 2:
												return "#FF7B10";
												break;
											case 3:
												return "#E5006C";
												break;
											default:
		                            			return "red";
										}
								})
								.attr("r", 3)
								
						feature.style("fill", function(d,i){
										switch(d.tier){
											case 1:
												return "#7323DC";
												break;
											case 2:
												return "#FF7B10";
												break;
											case 3:
												return "#E5006C";
												break;
											default:
		                            			return "red";
										}
								})
								.attr("r", 3)
								.on("mouseover", function(d){return tip.show(d);})
								.on("mouseout", tip.hide)
								.call(tip)
						feature.exit().remove();


								
				map.on("viewreset", update);
				update();

				function update() {
					feature.attr("transform", 
						function(d){
							// console.log(d, map.latLngToLayerPoint(d.LatLng).x);
							return "translate(" + 
								map.latLngToLayerPoint(d.LatLng).x + "," + 
								map.latLngToLayerPoint(d.LatLng).y + ")";
						})
				}
		    }

    		reduceDimension = ndx.dimension(function(d){ return "Reduced";})

    		console.log(reduceDimension.top(Infinity));

    		tierTypeChart = dc.rowChart("#tierTypeRowChart");
    		tierTypeChart
    			.width(200)
    			.height(200)
    			.dimension(tierTypeDimension)
    			.group(tierTypeGroup)
	            .colors(d3.scale.ordinal().domain(["tier1","tier2", "tier3"])
	                                    .range(["#7323DC","#FF7B10", "#E5006C"]))
	            .title(function(d) {
	             return "tier "+d.key+" has "+d.value+" hotels"; })
	            .elasticX(true)
	            .margins({top: 0, right: 10, bottom: 35, left: 20})
	            .gap(20)
	            .labelOffsetY(-3)
	            .labelOffsetX(1)
	            .on('postRender', function(chart) {
						   tierTypeChart.svg().append('text').attr('class', 'y-label').attr('text-anchor', 'middle')
						      .attr('x', -100).attr('y', 40).attr('dy', '-25').attr('transform', 'rotate(-90)')
						      .text('tiers (hover on bars)');
						})
	            .on("filtered", function(d,i){
	            	// tierTypeFilterDimension.filterAll();
	            	// console.log(d,i);
	            	console.log(tierTypeChart.hasFilter(i));
	            	console.log(tierTypeChart.hasFilter((i+1)%2));
	            	console.log(tierTypeChart.hasFilter((i+2)%3));
	            	// tierTypeDimension.filterAll();
	            	if(tierTypeChart.hasFilter(i)){

	            	}
	            	else{
	            		// tierTypeDimension.filterAll();
	            		tierTypeFilterDimension.filterAll();

	            	}
	            	// tierTypeGroup = tierTypeDimension.group();
	            	// console.log(d,i);
	            	hotelPoints();
	            	dc.redrawAll();
	            })

	        tierTypeChart.xAxis().ticks(4);
	        dc.renderAll();
    	})

		</script>
	</body>
</html>